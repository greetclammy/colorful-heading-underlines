var u=Object.defineProperty;var m=Object.getOwnPropertyDescriptor;var v=Object.getOwnPropertyNames;var w=Object.prototype.hasOwnProperty;var y=(a,d)=>{for(var t in d)u(a,t,{get:d[t],enumerable:!0})},E=(a,d,t,r)=>{if(d&&typeof d=="object"||typeof d=="function")for(let e of v(d))!w.call(a,e)&&e!==t&&u(a,e,{get:()=>d[e],enumerable:!(r=m(d,e))||r.enumerable});return a};var T=a=>E(u({},"__esModule",{value:!0}),a);var H={};y(H,{default:()=>p});module.exports=T(H);var f=require("obsidian"),p=class extends f.Plugin{constructor(){super(...arguments);this.observer=null;this.pendingProcess=!1}async onload(){this.setupObserver(),this.app.workspace.onLayoutReady(()=>{this.app.workspace.trigger("parse-style-settings"),this.processAllHeadings()}),this.registerEvent(this.app.workspace.on("file-open",()=>{this.processAllHeadings()})),this.registerEvent(this.app.workspace.on("layout-change",()=>{this.processAllHeadings()})),this.registerDomEvent(document,"selectionchange",()=>{this.pendingProcess||(this.pendingProcess=!0,requestAnimationFrame(()=>{this.pendingProcess=!1,this.processAllHeadings()}))})}onunload(){this.observer&&this.observer.disconnect(),this.clearAllWidths()}clearAllWidths(){document.querySelectorAll('[style*="--underline-width"]').forEach(t=>{t.style.removeProperty("--underline-width")})}getWidthMode(){return document.body.classList.contains("chu-width-last")?"last":document.body.classList.contains("chu-width-full")?"full":"widest"}setupObserver(){this.observer=new MutationObserver(t=>{for(let r of t){if(r.type==="attributes"&&r.target===document.body){this.processAllHeadings();return}let e=r.target;if(e.nodeType===Node.ELEMENT_NODE){if(e.closest(".markdown-preview-view, .cm-editor")){this.processAllHeadings();return}}else if(e.nodeType===Node.TEXT_NODE){let n=e.parentElement;if(n!=null&&n.closest(".markdown-preview-view, .cm-editor")){this.processAllHeadings();return}}}}),this.observer.observe(document.body,{childList:!0,subtree:!0,characterData:!0,attributes:!0,attributeFilter:["class"]})}processAllHeadings(){document.querySelectorAll(".markdown-preview-view h1, .markdown-preview-view h2, .markdown-preview-view h3, .markdown-preview-view h4, .markdown-preview-view h5, .markdown-preview-view h6").forEach(e=>this.processHeading(e)),document.querySelectorAll(".cm-line.HyperMD-header-1, .cm-line.HyperMD-header-2, .cm-line.HyperMD-header-3, .cm-line.HyperMD-header-4, .cm-line.HyperMD-header-5, .cm-line.HyperMD-header-6").forEach(e=>this.processEditingLine(e))}processHeading(t){var s,h;let r=this.getWidthMode();if(r==="full"){t.style.removeProperty("--underline-width");return}let e=document.createRange(),n=this.getTextNodes(t);if(n.length===0)return;let c=n[0],l=n[n.length-1];e.setStart(c,0),e.setEnd(l,(h=(s=l.textContent)==null?void 0:s.length)!=null?h:0);let i=e.getClientRects();if(i.length===0)return;let o=0;if(r==="last")o=i[i.length-1].width;else for(let g of i)g.width>o&&(o=g.width);o>0&&t.style.setProperty("--underline-width",`${o}px`)}processEditingLine(t){let r=this.getWidthMode();if(r==="full"){t.style.removeProperty("--underline-width");return}let e=t.querySelectorAll(".cm-header");if(e.length===0)return;let n=document.createRange();n.setStartBefore(e[0]),n.setEndAfter(e[e.length-1]);let c=n.getClientRects();if(c.length===0)return;let l=[],i=null;for(let s of c)s.width!==0&&(!i||Math.abs(s.top-i.top)>2?(i={top:s.top,left:s.left,right:s.right},l.push(i)):(i.left=Math.min(i.left,s.left),i.right=Math.max(i.right,s.right)));if(l.length===0)return;let o=0;if(r==="last"){let s=l[l.length-1];o=s.right-s.left}else for(let s of l){let h=s.right-s.left;h>o&&(o=h)}o>0&&t.style.setProperty("--underline-width",`${o}px`)}getTextNodes(t){let r=[],e=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,{acceptNode:c=>{var l,i,o;return(l=c.parentElement)!=null&&l.closest(".heading-collapse-indicator")?NodeFilter.FILTER_REJECT:((o=(i=c.textContent)==null?void 0:i.trim().length)!=null?o:0)>0?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT}}),n;for(;n=e.nextNode();)r.push(n);return r}};
